x-common-logging: &common_logging
  driver: json-file
  options: { max-size: "10m", max-file: "5" }

x-common-resources: &common_resources
  deploy:
    resources:
      limits: { cpus: "1.50", memory: "512M" }
      reservations: { cpus: "0.10", memory: "128M" }

services:
  nginx:
    pull_policy: always
    restart: unless-stopped
    ports: []                       # <— no host port in prod
    environment: [NODE_ENV=production]
    volumes:
      - ./../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./../nginx/snippets:/etc/nginx/snippets:ro
    read_only: true
    tmpfs: [/var/cache/nginx, /var/run, /var/log/nginx]
    security_opt: [no-new-privileges:true]
    cap_drop: [NET_ADMIN, SYS_ADMIN]
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://localhost/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 20s
    logging: *common_logging
    <<: *common_resources

  api:
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ./../compose/.env.production
    environment:
      - ENV=production
      - CORS_ORIGINS=https://jargonless.ai
    ports: []                       # <— no host port in prod
    read_only: true
    tmpfs: [/tmp]
    security_opt: [no-new-privileges:true]
    cap_drop: [SYS_ADMIN, NET_ADMIN]
    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://localhost:8000/api/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    logging: *common_logging
    <<: *common_resources